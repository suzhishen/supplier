<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Demo</title>
    <script type="text/javascript" src="/web/static/lib/jquery/jquery.js"></script>
    <!-- 请勿在项目正式环境中引用该 layui.css 地址 -->
    <link href="../../layui/css/layui.css" rel="stylesheet">
    <link href="./fllow_add_data_render_view.css" rel="stylesheet">
    <style></style>
</head>
<body>
<!--<form id="formData">-->
<!--    <strong>-->
<!--        <div>-->
<!--            <span style="width: 8%; padding: 2% 0px 0px 1%; display: inline-block;color: cornflowerblue;">尺码：欠数</span>-->
<!--            <span style="color: cornflowerblue;">装箱明细</span>-->
<!--        </div>-->
<!--    </strong>-->
<!--    <label for="S"><strong>S：-3</strong></label>-->
<!--    <span id="S_span" style="margin-right: 1%;">-->
<!--        <input type="text" class="layui-input" name="S" disabled>-->
<!--        <button type="button" class="btn_class" onclick="editInput(event)">编辑</button>-->
<!--    </span>-->
<!--    <button type="button" class="layui-btn layui-bg-blue" onclick="addInput('S')">加新箱</button>-->


<!--    <br><label for="M"><strong>M：-4</strong></label>-->
<!--    <span id="M_span"><input type="text" class="layui-input" name="M"><button>单独控制</button></span>-->
<!--    <button type="button" class="layui-btn layui-bg-blue" onclick="addInput('M')">加新箱</button>-->
<!--    <br><label for="L"><strong>L：56</strong></label>-->
<!--    <span id="L_span"><input type="text" class="layui-input" name="L"><button>单独控制</button></span>-->
<!--    <button type="button" class="layui-btn layui-bg-blue" onclick="addInput('L')">加新箱</button>-->
<!--    <br>-->
<!--</form>-->

<form id="formData">
    <strong>
        <div>
            <span style="width: 8%; padding: 2% 0px 0px 1%; display: inline-block;color: cornflowerblue;">尺码：欠数</span>
            <span style="color: cornflowerblue;">装箱明细</span>
        </div>
    </strong>
</form>

<script>
    function editInput(event) {
        console.log('addInput1');
        event.stopPropagation();
        const button = event.target;
        const input = button.previousElementSibling;

        if (input.disabled) {
            input.disabled = false;
            button.textContent = '保 存';
        } else {
            input.disabled = true;
            button.textContent = '修 改';
        }
    }

    function addInput(inputId) {
        console.log('addInput');
        var lastInput = $('#' + inputId).parent().find('input').last();
        var newInput = $('<input type="text" class="layui-input">').attr('name', inputId);
        if (lastInput.length === 0) {
            console.log(lastInput)
            lastInput = $('#' + inputId + '_span');
            newInput = $('<input type="text" class="layui-input">').attr('name', inputId);
            lastInput.append(newInput);
            return
        }
        lastInput.after(newInput);
    }

    $(document).ready(function () {
        let url = new URL(window.location.href);
        let searchParams = new URLSearchParams(url.search);
        let incomplete_line = JSON.parse(searchParams.get('incomplete_line'));
        let packed_list = JSON.parse(searchParams.get('packed_list'));
        let packed_size = JSON.parse(searchParams.get('packed_size'));

        const new_size = [];
        incomplete_line.forEach(item => {
            const packedItem = packed_list.find(packed => packed.size === item.size_name);
            const quantity = packedItem ? item.product_qty - packedItem.quantity : item.product_qty;
            new_size.push({"size_name": item.size_name, "product_qty": quantity, 'save_data': []});
        });
        console.log(new_size);
        // 处理显示未录入的数据
        for (let i = 0; i < new_size.length; i++) {
            for (let j = 0; j < packed_size.length; j++) {
                if (new_size[i].size_name === packed_size[j].size) {
                    // new_size[i].save_data.push(packed_size[j].quantity)
                    new_size[i].save_data.push(packed_size[j])
                }
            }
        }

        let labels = ''
        for (let i = 0; i < new_size.length; i++) {
            let inputs = ''
            var index = 0
            // 处理显示已录入的数据
            for (let j = 0; j < new_size[i].save_data.length; j++) {
                if (new_size[i].save_data[index].synch_state === 'have_synch') {
                    inputs += `<input type="text" class="layui-input" id="${new_size[i].save_data[index].id}" name="${new_size[i].size_name}" value="${new_size[i].save_data[index].quantity}" disabled/>`
                } else {
                    // inputs += `<input type="text" class="layui-input" id="${new_size[i].save_data[index].id}" name="${new_size[i].size_name}" value="${new_size[i].save_data[index].quantity}"/>`
                    inputs += `
<span>
<input type="text" class="layui-input" id="${new_size[i].save_data[index].id}" name="${new_size[i].size_name}" value="${new_size[i].save_data[index].quantity}" disabled/>
 <button type="button" class="btn_class" onclick="editInput(event)">修 改</button>
</span>`
                }
                index += 1
            }

            labels += `<label for="${new_size[i].size_name}"><strong>${new_size[i].size_name}：${new_size[i].product_qty}</strong></label>
            <span id="${new_size[i].size_name}_span">${inputs}</span>
            <button type="button" class="layui-btn layui-bg-blue" onclick="addInput('${new_size[i].size_name}')">加新箱</button>
            <br>`;
        }

        $('#formData').append(labels)

        // $('#formData').on('change', 'input', function (event) {
        $('#formData').on('input', 'input', function (event) {
            console.log(event.target.value)
            const input = event.target.value;
            if (!/^[0-9]*$/.test(input)) {
                event.target.classList.add('invalid');
            } else {
                event.target.classList.remove('invalid');
            }
        });

        // // 为每个添加按钮绑定点击事件
        // $('button').click(function () {
        //     // 获取与按钮对应的input的id
        //     var inputId = $(this).prev('input').attr('id');
        //     addInput(inputId);
        // });
    });

</script>
</body>
</html>
